---
title: 'Wavelets: Sparsity issue'
author: "Kushal K Dey"
date: "December 11, 2015"
output: html_document
---

In this script, we start with wavelet modeling of a function and then use the wavelet technique to perform factor analysis (sparse factor analysis) for a toy example 

## Toy example

```{r echo=TRUE, eval=TRUE}

library(cellcycleR)
G <- 20;
num_cells <- 300;
amp_genes <- rep(10, G);
phi_genes <- runif(G, 0, 2*pi)
sigma_genes <- rchisq(G, 4);
cell_times_sim <- sort(sample(seq(0,2*pi, 2*pi/(num_cells-1)), num_cells, replace=FALSE));
cycle_data <- sim_sinusoidal_cycle(G, amp_genes, phi_genes, sigma_genes, cell_times_sim);
```

We generate a toy example of `r G` sinusoidal gene expression patterns across `r num_cells` time points (synchronized for all genes). We first focus on the sine curve function for one gene (the first gene). The pattern is given below

```{r eho=TRUE, eval=TRUE}
plot(cycle_data[,1], type="l")
```

We now apply the wavelet transform using the *Wavethresh* package and see what wavelet coefficients we get and how good an approximation to the original function is obtained. 

We use the truncation

```{r echo=TRUE, eval=TRUE}
library(wavethresh)
data2=cycle_data[1:(2^8),1]
plot(data2)
wd1 <- wd(data2, filter.number = 1, family="DaubExPhase")
wr1 <- wr(wd1)
plot(wr1, type="l")
```

We use the padding with 0 now.

```{r echo=TRUE, eval=TRUE}
data3=cycle_data[,1];
length(data3)<-2^ceiling(log(length(data3),2))
data3[is.na(data3)]<-0
plot(data3)
wd2 <- wd(data3, filter.number = 1, family="DaubExPhase")
wr2 <- wr(wd2)
plot(wr2, type="l")
```


We look at how many non-zero wavelet coefficients are obtained, remember that wavelet representation should be sparse for smoothly varying functions in particular. 

```{r echo=TRUE, eval=TRUE}
length(which(wd1$D > 0)) / length(wd1$D)
length(which(wd2$D > 0)) / length(wd2$D)
```

Now suppose that the original cell times are not known. In this case, we know some permutation of the cell times and the pattern of the gene expression under this permutation is much more haphazard. In this case, there is less structure in the
patterns of gene expression and so, we expect the wavelet transform to not be as sparse as previous case.

We start with a permutation.

```{r echo=TRUE, eval=TRUE}
data2_perm <- sample(data2,length(data2), replace=FALSE);
plot(data2_perm, type="l")
data3_perm <- sample(data3,length(data3), replace=FALSE);
plot(data3_perm, type="l")
```

Now we model using wavelets 

```{r echo=TRUE, eval=TRUE}
wd1_perm <- wd(data2_perm, filter.number = 1, family="DaubExPhase")
wr1_perm <- wr(wd1_perm)
plot(wr1_perm, type="l")

wd2_perm <- wd(data3_perm, filter.number = 1, family="DaubExPhase")
wr2_perm <- wr(wd2_perm)
plot(wr2_perm, type="l")


```

Now check the number of non-zero wavelet coefficients 

```{r echo=TRUE, eval=TRUE}
length(which(wd1_perm$D > 0)) / length(wd1_perm$D)
length(which(wd2_perm$D > 0)) / length(wd2_perm$D)
```

We now repeat this sample permutation many times, obtain a distribution of number of non-zero wavelet coefficients in each case and then check where the true value (corresponding to actual ordering) lies.

```{r echo=TRUE, eval=TRUE}
num_perms <- 500;
prop_wd1 <- array(0, num_perms);
prop_wd2 <- array(0, num_perms);

for(n in 1:num_perms)
{
  data2_perm <- sample(data2,length(data2), replace=FALSE);
  data3_perm <- sample(data3,length(data3), replace=FALSE);
  wd1_perm <- wd(data2_perm, filter.number = 1, family="DaubExPhase")
  wd2_perm <- wd(data3_perm, filter.number = 1, family="DaubExPhase")
  prop_wd1[n] = length(which(wd1_perm$D > 0)) / length(wd1_perm$D);
  prop_wd2[n] = length(which(wd2_perm$D > 0)) / length(wd2_perm$D);
}

plot(density(prop_wd1));
abline(v=length(which(wd1$D > 0)) / length(wd1$D), col="red")

plot(density(prop_wd2), xlim=c(0.2,0.6));
abline(v=length(which(wd2$D > 0)) / length(wd2$D), col="red")


```

So, it seems that it is not really true that a false ordering which makes the pattern non-smooth corresponds to more non-zero wavelet coefficients. It worked that way when padded with zeros, but otherwise it is not so convincing for the
case where the first case with truncated gene expression.



